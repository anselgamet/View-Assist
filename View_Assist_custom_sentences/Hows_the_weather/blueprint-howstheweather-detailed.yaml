# View Assist - How's the Weather (v 1.0.1)
# Special thanks to Scratt for his work on this blueprint
blueprint:
  name: View Assist - How's the Weather?
  description: Ask "How's the Weather?" and ViewAssist will respond with the weather and show the weather view (View Assist howstheweather v 1.0.0)
  domain: automation
  input:
    hourly_command_prompt:
      name: Command Text
      description: The phrase you want to use to trigger the automation
      default: "(How's | How is | What's | What is) [the] weather [like]"
    daily_command_prompt:
      name: Command Text
      description: The phrase you want to use to trigger the automation
      default: "(How's | How is | What's | What is) [the] weather [like] (this week | tomorrow)"
    weather_entity: 
      name: Weather Entity
      description: The entity that provides weather information (example weather.home)
      selector:
        entity:
          filter:
            - domain: weather
      default: "weather.forecast_home"
    forecast_hourly_entity: 
      name: Forecast Hourly Entity
      description: The entity that provides hourly forecast (https://www.home-assistant.io/integrations/template/#trigger-based-handling-of-action-response-data)
      selector:
        entity:
          filter:
            - domain: sensor
      default: "sensor.weather_forecast_hourly"
    forecast_daily_entity: 
      name: Forecast Daily Entity
      description: The entity that provides daily forecast (https://www.home-assistant.io/integrations/template/#trigger-based-handling-of-action-response-data)
      selector:
        entity:
          filter:
            - domain: sensor
      default: "sensor.weather_forecast_daily"
    group_entity: 
      name: Group Entity
      description: The group that holds the list of View Assist satellites(example group.viewassist_satellites)
      selector:
        entity:
          filter:
            - domain: group
      default: "group.viewassist_satellites"                  
    hourly_dashboard:
      name: Dashboard Weather view
      description: The View Assist dashboard view to use for weather (example /dashboard-viewassist/weather)
      default: "/dashboard-viewassist/weather" 
    daily_dashboard:
      name: Dashboard Weather view
      description: The View Assist dashboard view to use for weather (example /dashboard-viewassist/weather)
      default: "/dashboard-viewassist/weather_daily" 
alias: View Assist - How's the weather
description: "Provides information on the current weather and forecast"
trigger:
  - platform: conversation
    command: !input hourly_command_prompt
    id: hourly_weather
  - platform: conversation
    command: !input daily_command_prompt
    id: daily_weather
variables:
  group_entity: !input group_entity
  weather_entity: !input weather_entity
  forecast_hourly_entity: !input forecast_hourly_entity
  forecast_daily_entity: !input forecast_daily_entity
  hourly_dashboard: !input hourly_dashboard
  daily_dashboard: !input daily_dashboard
condition: []
action:
  - variables:
      target_satellite_device: |-
        {% for sat in expand(group_entity) %}
          {% if (device_id(sat.attributes.mic_device)  == trigger.device_id) or (device_id(sat.attributes.display_device)  == trigger.device_id) %}
            {{ sat.entity_id }}
          {% endif %}
        {% endfor %}
      target_display_device: "{{ device_id(state_attr(target_satellite_device, 'display_device')) }}"
      target_mediaplayer_device: "{{ state_attr(target_satellite_device, 'mediaplayer_device') }}"
      target_satellite_device_type: "{{ state_attr(target_satellite_device, 'type') }}"
    enabled: true
  - choose:
      - conditions:
          - condition: trigger
            id:
              - hourly_weather
        sequence:
          - set_conversation_response: >-
              Its {{ state_attr(weather_entity, 'temperature') }} degrees and {{states[weather_entity].state}}
          - if:
              - condition: template
                value_template: "{% if target_satellite_device_type != 'audio_only' %}true{% else %}false{% endif %}"
            then:
              - service: browser_mod.navigate
                data:
                  path: "{{ hourly_dashboard }}"
                target:
                  device_id: "{{ target_display_device }}"
            enabled: true

      - conditions:
          - condition: trigger
            id:
              - daily_weather
        sequence:
          - set_conversation_response: >-
              Tomorrow it'll be {{ state_attr(forecast_daily_entity, 'forecast')[0].temperature }} degrees and {{ state_attr(forecast_daily_entity, 'forecast')[0].condition }}.
          - if:
              - condition: template
                value_template: "{% if target_satellite_device_type != 'audio_only' %}true{% else %}false{% endif %}"
            then:
              - service: browser_mod.navigate
                data:
                  path: "{{ daily_dashboard }}"
                target:
                  device_id: "{{ target_display_device }}"
            enabled: true
mode: single
